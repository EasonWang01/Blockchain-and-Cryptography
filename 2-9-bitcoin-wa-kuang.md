## 2-9 Bitcoin 挖礦

我們常在新聞上看到，許多人使用了CPU、顯示卡或是專門的礦機進行挖礦，或是加入了礦池，那麼究竟什麼是挖礦呢?

挖礦其實就是在幫忙驗證區塊鏈中的交易，因為區塊鏈是去中心化的，所以必須想一個辦法讓發出來的交易是合理的並可以驗證，這時這些礦工就提供了算力，來進行交易的驗證，並算出新的區塊。

每個礦工會把目前尚未被驗證的交易蒐集起來，然後納入自己目前正在計算的區塊中，如果這位礦工成功的算出了新區塊，則他所納入該區塊的交易也都會被驗證，所以交易被驗證的意思及代表著交易被納入到區塊中。

#### 挖礦獎勵

礦工挖礦獲得的獎勵有兩種，區塊獎勵以及新區塊內所含的所有交易之手續費。

區塊獎勵每隔210000個區塊後會減少一半，所以從2009年一月每個區塊獎勵50比特幣，到2012年11月減半為25個，之後近乎於四年減少一半，而最後20,999,999,980個比特幣都被挖完的時間約為2140年，之後挖礦的獎勵只會剩下交易手續費。

#### 區塊難度

比特幣中平均每十分鐘會出一個新區塊，而為了控制出塊的時間，比特幣有公式來控制其挖礦難度。

難度在每2016個區塊被挖出後會自動按照公式更改一次。

1.使用Bitcoin API getDifficulty取得現在的難度

> [https://blockexplorer.com/api/status?q=getDifficulty](https://blockexplorer.com/api/status?q=getDifficulty)

2.從難度去反推現在要計算的Target \(利用公式\)

```
target = coefficient * 2^(8 * (exponent – 3))
```

假設在區塊277,316中，它的值為 0x1903a30c

```
將0x1903a30c分為前兩位十六進位數字，與後面的六位。在這個區塊裡，0x19為前兩位，而 0x03a30c 為後六位。

由此上面公式及難度的值 0x1903a30c，可得：
target = 0x03a30c * 2^(0x08 * (0x19 - 0x03))

=> target = 0x03a30c * 2^(0x08 * 0x16)

=> target = 0x03a30c * 2^0xB0

按十進位計算為：
=> target = 238,348 * 2^176 = 22,829,202,948,393,929,850,749,706,076,701,368,331,072,452,018,388,575,715,328

轉為十六進制後為：
=> target =0x0000000000000003A30C00000000000000000000000000000000000000000000
```

> 發生在比特幣的最大難度為
>
> ```
> 0x00ffff * 2**(8*(0x1d - 3)) = 0x00000000FFFF0000000000000000000000000000000000000000000000000000
> ```
>
> 所以目前難度計算方式為
>
> ```
> difficulty = difficulty_1_target(最大難度) / current_target
> ```
>
> difficulty\_1\_target也稱為挖礦可能的最大難度，其為前32 bits為0後面均為1的二進位數字，但因為比特幣使用較少的浮點數精準度所以變成後幾位都是0

#### 挖礦的競爭方式

挖出新區塊可以獲得比特幣獎勵，那麼他們是如何做競爭呢?

礦工們會把區塊頭進行兩次sha256的加密，只要比一個target數小，及為挖到新的區塊。

區塊頭結構類似如下，包含在區塊中\(以下為範例，數值在每個區塊都會不同\)

```
Version: 536870912
Prev block: 0000000000000000008D8AF3B55F92BFFEBF286D9C87C54F80C780224F8DD06C
Merkle root: AA5FB4AFB0154D2BDD3315E074F219351FDF13908F1C515E07BE12124A3D3760
Timestamp: February 16, 2017, 17:35:35 +0800
Bits: 18029AB9
Nonce: 一個隨機數
```



