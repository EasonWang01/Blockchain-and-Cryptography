# 區塊鏈核心概念

#### 簡介

> 許多交易組成區塊，許多區塊前後互相鏈結，組成區塊鏈。

想像在遠古部落，部落酋長口頭下令了新的部落政策，雖然當時沒有紙筆做記錄，但族人們聽到後口耳相傳，之後這個政策雖然沒有被一個中心把它記錄下來，但大家心中都知道這件事情了，如果之後這個下這個政策的酋長離職了，剩下的人會以大多數人講的為真，如果未來有人想竄改先前酋長講過的政策，也會因為與大多數族人講的不同而被拒絕。

#### 理解區塊鏈

比特幣可以說是近年加密貨幣與區塊鏈技術應用發展的開頭，後起的區塊鏈技術參考了許多比特幣本身的核心原理。在本書接下來的章節中會先說明比特幣是如何運作，過程中會將會一步一步講解區塊鏈的相關概念，並且介紹如何申請一個自己的比特幣地址與錢包，進行購買比特幣與轉帳等動作。

> Bitcoin is an innovative payment network and a new kind of money.
>
> 源自比特幣官網 [https://bitcoin.org/en/](https://bitcoin.org/en/)

我們時常從新聞報導或朋友閒聊間聽到：今天比特幣價格又飆漲或下跌了、某位玩家又投資了新的礦機或礦場等等，但大家可能會想的第一個問題可能是：在電腦上的數字貨幣真的夠安全嗎？

接著進一步思考，我們會想到在網路上刷信用卡不也是虛擬交易嗎，那線上刷信用卡跟我們使用比特幣交易的差別又在哪裡？

#### 加密貨幣錢包

為了能在區塊鏈網路裡進行交易，你需要一個比特幣地址，它讓你可以存放你的比特幣，更明確的來說，是該地址在區塊鏈上紀錄的餘額。比特幣地址是由一個隨機的私鑰所產生之對應公鑰，接著再進行一些雜湊方法與編碼，最後所算出的值即為比特幣地址 \( 將會在後續章節詳細介紹產生方式 \)。

> 比特幣地址類似於：14qViLJfdGaP4EeHnDyJbEGQysnCpwn1g
>
> 可用的比特幣位址數量接近2的161次方，假如地球上之沙子數量有2的63次方，而每一粒沙中有一個地球，那麼比特幣位址總數比所有這些「 地球 」上的所有的沙子的數量還多。

每個公鑰都是由一個私鑰所產生，私鑰通常為隨機產生，且其隨機的程度攸關其安全性。

如果一個訊息被公鑰加密，只有配對的私鑰才能解密讀到訊息。反之，如果用私鑰加密訊息，只有相對的公鑰可以解密。所以當小明想要轉帳小王，他需要用他的私鑰將轉帳訊息加密後，送到網路裡，然後每個節點使用小明的公鑰將訊息解開，以確認是由小明發送的。

在加密完成時會產生一個**數位簽章**，它會被節點們用來確認交易訊息的發送來源和真偽。**數位簽章**內容是一串文字，它是由私鑰對交易訊息所簽發出的一段雜湊值。如果你更改交易訊息中任何一個字元，電子簽名也會跟著改變，所以駭客很難更改你的交易訊息或是修改交易金額。

\( 可從下圖看到貨幣持有者用自己的私鑰簽發交易，然後將產生的簽名和公鑰一起附加在交易本文中。將會在後續比特幣交易章節詳細介紹 \)

![](/assets/螢幕快照 2018-01-31 下午5.42.41.png)

#### 查詢餘額

我們轉帳後比特幣是如何知道我們現在帳戶餘額是多少呢？

剛才有提到比特幣網路的組成是由全世界跑著比特幣節點程式的電腦所構成，每個節點電腦會進行驗證交易與同步其他節點資料的動作且都保有一份區塊鏈帳本，但節點是如何知道你的帳戶餘額？區塊鏈系統並沒有記錄每個人的帳戶餘額，事實上，它只有紀錄網路上每筆交易紀錄。

> _持有比特幣代表的是：於區塊鏈帳本上查詢你的地址還存在著尚未變成輸入交易之紀錄。_

\(看到下圖，如果在Out後的箭頭沒有連接著其他In的話，則其即為目前帳戶的餘額，也稱為`Unspend Output`\)

![](/assets/螢幕快照 2018-01-31 下午5.42.41 拷貝 2.png)

#### 區塊中的交易

> ![](/assets/交易齒輪.png)[https://medium.com/@micheledaliessi/how-does-the-blockchain-work-98c8cd01d2ae](https://medium.com/@micheledaliessi/how-does-the-blockchain-work-98c8cd01d2ae)

看到上圖，每個產生的交易被節點接收到並驗證後會先到交易池中，等待著被節點納入下一個區塊，每個節點都可以將若干個交易訊息從交易池中選取並且進行進行挖礦，如果成功解出工作量證明，即可將算出的證明結合打包的區塊一起發送到網路上，並建議其為鏈上的最新區塊。

區塊鏈系統使用密碼學方法\( 後面章節會提到實作 \)設計了一道複雜的數學題，只要有正確答案，就可以成爲鏈上的最新區塊。這個答案是由節點計算後一起被打包進區塊。答案是一個數字，得到答案的唯一方法就是不斷地雜湊計算。哪個節點先得到了答案，它就可以儘速廣播給其他節點新的區塊內容，並且將它的算出的區塊放到鏈上。

每個節點都有一份區塊鏈資料，當節點拿到其他節點丟出來的新區塊\( 已有正確答案的 \)，經過驗證後就會把新區塊放到本身節點的鏈上，同時系統會要求節點搜尋網路裡有沒有比它的本身節點上的鏈更長的鏈，如果有，則會捨棄原有的鏈，取用更長的鏈。

![](/assets/區塊鏈簡圖.png)

在上圖中，我們可以看到每個方塊中都包含一些數值，這些值即為存放在區塊鏈中的區塊資料

1.區塊鏈是由包含交易訊息的區塊，從前後有序串接起來的數據結構，每個新區塊都指向前一個區塊 \( 父區塊 \)。

2.對每個區塊頭進行SHA256雜湊，每個區塊頭都包含它的父區塊Hash值。而每個區塊連接到各自父區塊的Hash值序列就創建了一條可以追溯到第一個區塊（創世區塊）的鏈條。

3.由於每個區塊的區塊頭包含`父區塊Hash值`，所以當前區塊的Hash值因此也受到前區塊的Hash值的影響。如果父區塊的Hash不一樣，則子區塊也會有不同的Hash，接著這個子區塊運算出來的下一個子區塊也會有不同Hash，這種瀑布效應將保證不會有任何區塊不會遭到竄改。

# Merkle Tree

我們可以直接把所有交易訊息放在區塊中，並直接針對區塊中的明文交易訊息做驗證，但這樣的缺點是會佔去許多區塊鏈上的空間，所以我們要一種更簡單的驗證方式，把區塊中所含的交易使用Merkle Tree演算法算出Merkle Root。

如果今天在區塊中的某一筆交易本文被竄改，則計算出來之Merkle Root也一定不同，利用這個特性可避免區塊中所含的歷史交易遭任意竄改，並且可以快速找到某筆交易的內容。

![](/assets/209c1e61-54a9-43e2-adb4-11821b28544b.png)

> [https://en.wikipedia.org/wiki/Merkle\_tree\#/media/File:Hash\_Tree.svg](https://en.wikipedia.org/wiki/Merkle_tree#/media/File:Hash_Tree.svg)

Merkle樹被用來歸納一個區塊中的所有交易，同時生成整個交易集合的數字指紋，可以快速校驗特定區塊是否存在某筆特定交易。

為了創建父節點H\(AB\)，子節點A和子節點B的雜湊值將被串聯。隨後將串連後的字串進行兩次雜湊來產生父節點的雜湊值，將會於後續交易相關章節詳細介紹。

```
H（AB）~= SHA256(SHA256(HA + HB))
```

# 挖礦

> Mining   = Securing the network = verify computation

當一個新的區塊被`挖掘`出來，每個區塊裡包含著被礦工從交易池中挑選出來的交易。我們把包含在區塊內且被添加到區塊鏈上的交易稱為`確認交易`，交易經過確認之後，新的擁有者才能夠花費他在交易中得到的比特幣。

礦工們在挖礦過程中會得到兩種類型的獎勵：創建新區塊的`coinbase`獎勵，以及區塊中所含所有交易之手續費總和。

> Finding a nonce input to the algorithm so that the result is below a certain threshold

區塊鏈用難度來控制下一個區塊的產生速度，而礦工利用當前的區塊頭加上一個隨機數Nonce，藉由改變Nonce並且做雜湊，來產生不同Hash，想辦法讓此Hash小於目前所設定難度的數值，如果產生一個低於設定難度的值即可成功挖到礦，也就是成功產生新的區塊。

#### 其他連結：

挖礦困難度解釋

[https://en.bitcoin.it/wiki/Target](https://en.bitcoin.it/wiki/Target)

挖礦時間估計

[http://coinish.com/bitcoin-mining-calculator/\#calc-information](http://coinish.com/bitcoin-mining-calculator/#calc-information)

#### 我們可以使用以下網頁進行挖礦模擬

[https://anders.com/blockchain/block.html](https://anders.com/blockchain/block.html)

> ![](/assets/挖礦難度.png)以上網站的Nonce為一個隨機值讓我們更改，實際挖礦時即為更改Nonce並想辦法算出結果，由於相同字串經過雜湊後的數值都一樣，但無法預料哪個字串經過雜湊後可以得到我們想要的數值，藉以用來當運算量的證明。
>
> 上圖下方的Data為模擬納入區塊中的附加訊息。

#### 目前市面上的幣種以及價格

當我們想要對目前市面上的加密貨幣進行投資時，我們必須先到市場上了解其價值

以下網站列出了一些市面上的加密貨幣可供我們參考

[https://coinmarketcap.com/](https://coinmarketcap.com/)

[https://www.coingecko.com/zh-tw](https://www.coingecko.com/zh-tw)

#### 其他相關Bitcoin schema介紹

以下網站列出了比特幣相關Database Schema

[https://webbtc.com/api/schema](https://webbtc.com/api/schema)

#### ![](/assets/bitcoin-data-schema.png)

#### 加密貨幣Market State圖表

列了許多市面上可見的加密貨幣，但採用了另一種方式將之呈現

[http://cryptomaps.org/](http://cryptomaps.org/)![](/assets/bitcoin-market-圖表.png)

# 共識機制介紹

在區塊鏈中因為沒有中心的機構來處理哪些是合法與正確的交易區塊，為了讓各個節點可以進行同步，並且達成共識，以下為三個常見的共識方法。

PoW（Proof of Work）

意思為工作量證明，工作量會取決於所執行的運算量，挖礦時會對區塊頭（Block Header）進行雜湊運算，當運算數值小於一個目標值後，及可挖出該區塊，一般的礦機或顯卡挖礦即為此種方式。

PoS（Proof of Stake）

根據持有貨幣的量和時間所得出的幣齡來決定下一個區塊由誰挖出，而每次由你挖出區塊後，你的幣齡就會歸零重新計算，被清空之幣齡達到特定數量後也可獲得獎勵。PoS可以預防 51% 攻擊，不必擔心未來如果區塊鏈算力降低時，整個區塊鏈網路的51%以上算力都被控制在特定人手上。

PoA \( Proof of Authority\)  
有別於PoW \( Proof-of-Work \)需要解數學難題來產生工作量證明，PoA是依靠預設好的認證節點\( Authority Nodes \)，負責產生區塊。  
可設定認證節點 \( Authority Node \)數量以及指定產生區塊的平均時間等等，所有區塊都只能由這些認證過的節點產生。

